<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte ATEMAX – AutoPlay + Synthèse OK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    /* … styles inchangés … */
  </style>
</head>
<body>
<a href="index.html" id="new-signal">➕ Faire un nouveau signalement</a>
<div id="windHud"></div>
<div id="map"></div>

<!-- … barre de commandes inchangée … -->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>

<script>
/* ---------------- Envoi vers Google Apps Script ---------------- */
async function logWeatherToSheet() {
  const url = 'https://script.google.com/macros/s/AKfycbxdxoRdfxwhcxtbpg7U83K_dxfOVO6WQJS0ZagNGs_HkjjvDVnrsse7CWx7Sx3W0Ddacw/exec';
  const lat = 44.212805;
  const lon = 0.597916;
  try {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ latitude: lat, longitude: lon }),
      headers: { 'Content-Type': 'application/json' }
    });
    const txt = await res.text();
    console.log('✅ Météo enregistrée via Apps Script :', txt.trim());
  } catch (err) {
    console.error('Erreur météo Apps Script :', err);
  }
}

/* ---------------- Helpers (inchangés) ---------------- */
function parseFrDate(str){ /* … */ }
function avg(arr){ /* … */ }
function avgDir(arr){ /* … */ }
function numVal(v){ /* … */ }
function windDirectionLabel(deg){ /* … */ }

/* ---------------- Carte ---------------- */
const map = L.map('map').setView([44.214, 0.606], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

/* --------- (ligne supprimée) --------- */
/* fetchLiveWind();  //  <<=== supprimé : provoquait les erreurs au chargement */

/* … reste de la configuration de la carte inchangé … */
const USINE      = [44.212805, 0.597916];
const windHudEl  = document.getElementById('windHud');

/* ---------------- Vent : rendu icône ---------------- */
function makeWindIconHTML(dirDeg, speedKmh){ /* … */ }
function updateWindMarker(dir, speed){ if (windHudEl) windHudEl.innerHTML = makeWindIconHTML(isNaN(dir)?0:dir, speed); }

/* ---------------- Lecture météo live ---------------- */
const fallbackLat = 44.212805;
const fallbackLon = 0.597916;
const API_KEY     = '5e7795e19d6fbcb80542a3ea152b1d1e';

async function fetchLiveWind(){
  try{
    const url   = `https://api.openweathermap.org/data/2.5/weather?lat=${fallbackLat}&lon=${fallbackLon}&appid=${API_KEY}&units=metric`;
    const json  = await (await fetch(url)).json();
    const deg   = json.wind?.deg;
    const speed = json.wind?.speed ? Math.round(json.wind.speed*3.6) : NaN;
    updateWindMarker(deg, speed);
  }catch(err){
    console.warn('Erreur récupération vent live :', err);
    updateWindMarker(NaN, NaN);
  }
}

/* -------------------------  Reste du script inchangé  ------------------------- */
/* – grouping, particules, slider, player, flatpickr, fetch Google Sheets, etc. – */

/* ─── Lancement immédiat au chargement de la page ────────── */
updateWindMarker(NaN, NaN);   // placeholder
logWeatherToSheet();          // enregistrement dans le tableur
fetchLiveWind();              // affichage du vent courant
</script>
</body>
</html>
