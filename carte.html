<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte - Usine ATEMAX (corrig√© sans "Choisir une date" original)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #new-signal {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 12px; border-radius: 8px;
      font-weight: bold; font-size: 14px; z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-decoration: none; color: black;
    }
    #controls {
      max-width: 92vw;
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 10px; border-radius: 10px;
      font-size: 13px; z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px;
    }
    label, select, input[type="checkbox"], input[type="range"], span { font-size: 13px; }
    input[type="range"] { width: 140px; transition: opacity 0.3s ease; }
    input[type="range"].disabled { opacity: 0.3; pointer-events: none; }

    /* On n'utilise plus display:none pour les inputs Flatpickr √† ouvrir via .open() */
    .hidden { opacity: 0; pointer-events: none; position: absolute; left: -9999px; top: -9999px; }

    .flatpickr-calendar { z-index: 3000 !important; }
    @media (max-width: 600px) {
      #controls { flex-wrap: wrap; overflow-x: auto; justify-content: flex-start; }
      input[type="range"] { width: 100px; }
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">‚ûï Faire un nouveau signalement</a>
<div id="map"></div>

<div id="controls">
  <div style="display:flex; align-items:center;">
    <span style="margin-right:4px;">üìÖ</span>
    <select id="preset">
      <option value="today">Aujourd‚Äôhui</option>
      <option value="yesterday">Hier</option>
      <option value="last7">7 derniers jours</option>
      <option value="last30">30 derniers jours</option>
      <option value="custom">P√©riode personnalis√©e</option>
      <option value="custom2">Choisir une date</option><!-- duplication/renommage -->
    </select>
  </div>

  <input id="customRange" type="text" class="hidden" placeholder="Date d√©but - fin" readonly />
  <input id="customRange2" type="text" class="hidden" placeholder="Choisir une date" readonly />

  <label><input type="checkbox" id="modeDynamic" checked /> √âvolution dynamique</label>

  <div style="display:flex; align-items:center; gap:6px;">
    <span style="margin-right:4px;">‚è±Ô∏è</span>
    <input type="range" id="slider" min="0" max="0" value="0" />
  </div>
  <span id="sliderLabel">00:00</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script>
  // --- Helpers ---
  function parseFrDate(str) {
    const [d, m, rest] = str.split('/');
    if (!rest) return new Date(str);
    const [y, time = '00:00:00'] = rest.split(' ');
    const [hh, mm, ss] = time.split(':');
    return new Date(+y, +m - 1, +d, +(hh||0), +(mm||0), +(ss||0));
  }

  // --- Map ---
  const map = L.map('map').setView([44.214, 0.606], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const usineIcon = L.divIcon({ html: '<div style="font-size:48px;">üè≠</div>', iconSize: [48,48], className: 'usine-marker' });
  L.marker([44.212805, 0.597916], { icon: usineIcon }).addTo(map).bindPopup("Usine d'incin√©ration ATEMAX");

  const getColor = i => ["#FADADD","#F5B7B1","#EC7063","#E74C3C","#CB4335","#943126","#78281F","#641E16","#512E2E"][Math.min(9, Math.max(0, i-1))];

  // --- State ---
  let allData = [], grouped = [], labels = [];
  const slider = document.getElementById('slider');
  const labelTxt = document.getElementById('sliderLabel');
  const modeDynamic = document.getElementById('modeDynamic');
  const preset = document.getElementById('preset');
  const customInput = document.getElementById('customRange');
  const customInput2 = document.getElementById('customRange2');

  // --- Map update ---
  const updateMap = (points) => {
    if (window.layer) map.removeLayer(window.layer);
    window.layer = L.layerGroup(points.map(p =>
      L.circle([p.lat, p.lon], {
        color: getColor(p.intensite),
        fillColor: getColor(p.intensite),
        fillOpacity: 0.6,
        radius: 60
      }).bindPopup(`<strong>${p.type}</strong><br>Intensit√© : ${p.intensite}/10<br>${p.commentaire}<br>${p.dateStr}`)
    )).addTo(map);
  };

  // --- Grouping ---
  const groupBy = (data, interval) => {
    const g = {};
    data.forEach(row => {
      const d = new Date(row.dateObj);
      if (interval === '10min') {
        d.setSeconds(0,0); d.setMinutes(Math.floor(d.getMinutes()/10)*10);
      } else if (interval === 'hour') {
        d.setMinutes(0,0,0);
      } else if (interval === 'day') {
        d.setHours(0,0,0,0);
      }
      const key = d.toISOString();
      (g[key] ||= []).push(row);
    });
    const keys = Object.keys(g).sort();
    labels = keys.map(k => new Date(k).toLocaleString('fr-FR'));
    return keys.map(k => g[k]);
  };

  // --- Refresh ---
  const refresh = (mode) => {
    let gtype = 'day';
    const today = new Date();

    if (mode === 'today' || mode === 'yesterday' || mode === 'custom2') gtype = '10min';
    else if (mode === 'last7')  gtype = 'hour';
    else if (mode === 'last30') gtype = 'day';
    else if (mode === 'custom') {
      const sel = fpRange.selectedDates;
      const diff = sel.length === 2 ? (sel[1] - sel[0]) / 86400000 : 0;
      gtype = diff <= 1 ? '10min' : diff <= 7 ? 'hour' : 'day';
    }

    const filtered = allData.filter(d => {
      const date = d.dateObj;
      if (mode === 'today')     return date.toDateString() === today.toDateString();
      if (mode === 'yesterday'){ const y = new Date(today); y.setDate(y.getDate()-1); return date.toDateString() === y.toDateString(); }
      if (mode === 'last7')     { const d7 = new Date(today); d7.setDate(d7.getDate()-7);  return date >= d7; }
      if (mode === 'last30')    { const d30 = new Date(today); d30.setDate(d30.getDate()-30); return date >= d30; }
      if (mode === 'custom')    { const [d1,d2] = fpRange.selectedDates; return d1 && d2 && date >= d1 && date <= d2; }
      if (mode === 'custom2')   { const sel = fpRange2.selectedDates; const d1 = sel[0]; const d2 = sel[1] || sel[0]; return d1 && date >= d1 && date <= d2; }
      return true;
    });

    grouped = groupBy(filtered, gtype);

    const canSlide = grouped.length > 1 && modeDynamic.checked;
    slider.disabled = !canSlide;
    slider.classList.toggle('disabled', !canSlide);
    slider.max = Math.max(0, grouped.length - 1);

    const lastIndex = Math.max(0, grouped.length - 1);
    slider.value = lastIndex;
    updateMap(grouped[lastIndex] || []);
    labelTxt.innerText = labels[lastIndex] || '';
  };

  // --- Dynamic mode toggle ---
  modeDynamic.onchange = () => {
    const canSlide = modeDynamic.checked && grouped.length > 1;
    slider.disabled = !canSlide;
    slider.classList.toggle('disabled', !canSlide);
    updateMap(canSlide ? grouped[slider.value] : grouped.flat());
    labelTxt.innerText = canSlide ? labels[slider.value] : '';
  };

  slider.oninput = () => {
    updateMap(grouped[slider.value]);
    labelTxt.innerText = labels[slider.value];
  };

  // --- Flatpickr ---
  flatpickr.setDefaults({ locale: 'fr' });

  // 1√®re p√©riode personnalis√©e
  const fpRange = flatpickr('#customRange', {
    mode: 'range',
    dateFormat: 'd/m/Y',
    onClose: () => refresh('custom')
  });

  // 2√®me (dupliqu√©e puis renomm√©e en "Choisir une date")
  const fpRange2 = flatpickr('#customRange2', {
    mode: 'range', // duplicata volontaire
    dateFormat: 'd/m/Y',
    onClose: () => refresh('custom2')
  });

  // --- Preset change ---
  preset.onchange = (e) => {
    const val = e.target.value;

    const showCustom  = val === 'custom';
    const showCustom2 = val === 'custom2';

    customInput.classList.toggle('hidden', !showCustom);
    customInput2.classList.toggle('hidden', !showCustom2);

    if (showCustom) {
      requestAnimationFrame(() => fpRange.open());
    } else if (showCustom2) {
      requestAnimationFrame(() => fpRange2.open());
    } else {
      refresh(val);
    }
  };

  // --- Load data ---
  fetch('https://opensheet.elk.sh/1z6YXiX0MKEwrZ0rnjgj4mfFSUSk6wRh6-kRK9JCSIzc/Feuille%201')
    .then(res => res.json())
    .then(rows => {
      allData = rows.map(r => {
        const dateStr = r['Date/heure'];
        const dateObj = parseFrDate(dateStr);
        return {
          lat: parseFloat(r['Latitude']),
          lon: parseFloat(r['Longitude']),
          intensite: parseInt(r['Intensit√©']),
          type: r['Type d‚Äôodeur'],
          commentaire: r['Commentaire'],
          dateStr,
          dateObj
        };
      }).filter(d => !isNaN(d.lat) && !isNaN(d.lon) && d.dateObj instanceof Date && !isNaN(d.dateObj));
      refresh('today');
    });
</script>
</body>
</html>
