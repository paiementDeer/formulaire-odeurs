<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte ATEMAX – AutoPlay + Synthèse OK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #new-signal {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 12px; border-radius: 8px;
      font-weight: bold; font-size: 14px; z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-decoration: none; color: black;
    }

    #windHud {
      position: absolute; top: 10px; right: 10px; z-index: 1002;
      display: flex; flex-direction: column; align-items: center; pointer-events: none;
    }
    .wind-icon svg { width:60px; height:60px; opacity:0.6; }
    .wind-speed {
      background:rgba(255,255,255,.85);
      padding:3px 8px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.25);
      font-weight:bold;text-align:center;margin-top:4px; font-size:11px;
    }

    #controls {
      max-width: 92vw;
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 10px; border-radius: 10px;
      font-size: 13px; z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px;
    }
    label, select, input[type="checkbox"], input[type="range"], span { font-size: 13px; }
    input[type="range"] { width: 140px; transition: opacity 0.3s ease; }
    input[type="range"].disabled { opacity: 0.3; pointer-events: none; }
    .hidden { display: none !important; }
    .flatpickr-calendar { z-index: 3000 !important; }

    #playerControls { display:flex; align-items:center; gap:6px; }
    #btnPlayPause {
      width:32px;height:32px;border:none;border-radius:50%;cursor:pointer;
      box-shadow:0 1px 3px rgba(0,0,0,.3);background:#E74C3C;color:#fff;font-size:16px;line-height:32px;padding:0;
      display:flex;align-items:center;justify-content:center;font-weight:bold;
    }
    #speedSelect{ border:1px solid #ccc; border-radius:6px; padding:2px 4px; }

    @media (max-width: 600px) {
      #controls { flex-wrap: wrap; overflow-x: auto; justify-content: flex-start; }
      input[type="range"] { width: 100px; }
    }

    canvas.particle-canvas {
      position:absolute; top:0; left:0; pointer-events:none; z-index: 500;
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">➕ Faire un nouveau signalement</a>
<div id="windHud"></div>
<div id="map"></div>

<script>
// Appel automatique à Google Apps Script pour récupérer météo
async function fetchLiveWind() {
  const url = 'https://script.google.com/macros/s/AKfycbxdxoRdfxwhcxtbpg7U83K_dxfOVO6WQJS0ZagNGs_HkjjvDVnrsse7CWx7Sx3W0Ddacw/exec';
  const lat = 44.212805;
  const lon = 0.597916;

  try {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify({ latitude: lat, longitude: lon }),
      headers: { 'Content-Type': 'application/json' }
    });
    const txt = await res.text();
    if (txt.trim() === 'OK') {
      console.log('✅ Météo enregistrée via Apps Script');
    } else {
      console.warn('Réponse inattendue :', txt);
    }
  } catch (err) {
    console.error('Erreur météo Apps Script :', err);
  }
}

function makeWindIconHTML(dirDeg, speedKmh){
  const svg = `<svg viewBox='0 0 100 100' style='transform: rotate(${(dirDeg + 180) % 360}deg);'>
    <path d='M50 4 L72 58 L56 52 L56 96 L44 96 L44 52 L28 58 Z' fill='black' fill-opacity='0.6' stroke='white' stroke-width='4' stroke-linejoin='round'/>
  </svg>`;
  const html = `<div class='wind-icon'>${svg}<div class='wind-speed'>${isNaN(speedKmh)?'?':speedKmh+' km/h'}</div></div>`;
  return html;
}

// (... reste de ton script...)

</script>

<script>
// Exemple : à la fin de l’ajout des points sur la carte
// (ligne à ajouter après map.addLayer ou similaire)
fetchLiveWind(); // Appel météo forcé même sans signalement
</script>

</body>
</html>
