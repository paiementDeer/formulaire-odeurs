<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>D√©mo particules de vent (Leaflet + Canvas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin:0; }
    .ctrl {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:6px 10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.25);
      font-family:sans-serif; font-size:13px;
    }
    .ctrl input { width:60px; }
    canvas.wind-canvas { pointer-events:none; } /* ne bloque pas les clics sur la carte */
  </style>
</head>
<body>
<div id="map"></div>
<div class="ctrl">
  Dir¬∞ <input id="dir" type="number" value="315"> | V(km/h) <input id="spd" type="number" value="15">
  <button id="apply">Appliquer</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ---------- Carte ----------
const USINE = [44.212805, 0.597916];
const map = L.map('map').setView([44.214, 0.606], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
L.marker(USINE, { icon: L.divIcon({html:'<div style="font-size:36px;">üè≠</div>',iconSize:[36,36]})}).addTo(map);

// ---------- Layer Canvas particules ----------
const canvas = document.createElement('canvas');
canvas.className = 'wind-canvas';
map.getPanes().overlayPane.appendChild(canvas);
const ctx = canvas.getContext('2d');

let particles = [];
let dirRad = 315 * Math.PI/180; // direction en radians
let speedPx = 0.5; // vitesse en px/frame
const NUM = 300;   // nombre de particules
const spawnRadiusMeters = 250; // rayon d'√©mission autour de l'usine

function resizeCanvas(){
  const size = map.getSize();
  canvas.width = size.x;
  canvas.height = size.y;
}
resizeCanvas();
map.on('resize', resizeCanvas);
map.on('moveend zoomend', ()=>{ // recalculer positions pixel
  particles.forEach(p => {
    const ll = L.latLng(p.lat, p.lng);
    const pt = map.latLngToContainerPoint(ll);
    p.x = pt.x; p.y = pt.y;
  });
});

// conversion simple m -> deg
function offsetLatLng(lat, lon, dxMeters, dyMeters) {
  const dLat = dyMeters / 111320;
  const dLon = dxMeters / (111320 * Math.cos(lat * Math.PI / 180));
  return [lat + dLat, lon + dLon];
}

// spawn une particule al√©atoire autour de l‚Äôusine
function spawnParticle(p){
  const angle = Math.random()*Math.PI*2;
  const dist = Math.random()*spawnRadiusMeters;
  const dx = Math.cos(angle)*dist;
  const dy = Math.sin(angle)*dist;
  const [lat, lng] = offsetLatLng(USINE[0], USINE[1], dx, dy);
  const pt = map.latLngToContainerPoint([lat,lng]);
  p.lat = lat; p.lng = lng; p.x = pt.x; p.y = pt.y;
  p.alpha = 0.4 + Math.random()*0.6;
  p.size = 1 + Math.random()*1.5;
}

function createParticles(){
  particles = [];
  for(let i=0;i<NUM;i++){
    const p = {};
    spawnParticle(p);
    particles.push(p);
  }
}
createParticles();

// animation
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.strokeStyle = 'rgba(0,0,0,0.7)';

  const vx = Math.cos(dirRad) * speedPx;
  const vy = Math.sin(dirRad) * speedPx;

  particles.forEach(p=>{
    // trail
    ctx.globalAlpha = p.alpha;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fill();

    p.x += vx;
    p.y += vy;

    // si la particule sort de l'√©cran -> respawn
    if (p.x<0 || p.y<0 || p.x>canvas.width || p.y>canvas.height){
      spawnParticle(p);
    }
  });

  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

// set wind from UI
function setWind(dirDeg, speedKmh){
  dirRad = dirDeg * Math.PI/180;
  // convert km/h to px/frame (tr√®s arbitraire pour la d√©mo)
  speedPx = Math.max(0.1, speedKmh/40);
}
document.getElementById('apply').onclick = ()=>{
  const d = +document.getElementById('dir').value;
  const s = +document.getElementById('spd').value;
  setWind(d, s);
};
</script>
</body>
</html>
