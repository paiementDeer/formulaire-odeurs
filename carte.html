<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte - Mode simple mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #new-signal {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-decoration: none;
      color: black;
    }
    #controls {
      max-width: 92vw;
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    label, select, input[type="checkbox"], input[type="range"], span {
      font-size: 13px;
    }
    input[type="range"] {
      width: 140px;
      transition: opacity 0.3s ease;
    }
    input[type="range"].disabled {
      opacity: 0.3;
      pointer-events: none;
    }
    .datepicker {
      display: none;
    }
    @media (max-width: 600px) {
      #controls {
      max-width: 92vw;
        flex-wrap: wrap;
      }
      input[type="range"] {
        width: 100px;
      }
    }

    .select-container {
      display: flex;
      align-items: center;
      flex-shrink: 1;
    }
    @media (max-width: 600px) {
      #controls {
        flex-wrap: wrap;
        overflow-x: auto;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">‚ûï Faire un nouveau signalement</a>
<div id="map"></div>
<div id="controls">
  <div class="select-container"><span style="margin-right: 4px;">üìÖ</span><select id="preset">
    <option value="today">Aujourd‚Äôhui</option>
    <option value="yesterday">Hier</option>
    <option value="last7">7 derniers jours</option>
    <option value="last30">30 derniers jours</option>
    <option value="custom">P√©riode personnalis√©e</option>
    <option value="single">Choisir une date</option>
  </select></div>
  <input id="customRange" class="datepicker" placeholder="Date d√©but - fin" />
  <input id="singleDate" class="datepicker" placeholder="Choisir une date" />
  <label><input type="checkbox" id="modeDynamic" checked /> √âvolution dynamique</label>
  <div class="slider-wrap" style="display: flex; align-items: center; gap: 6px;">
    <span style="margin-right: 4px;">‚è±Ô∏è</span>
    <input type="range" id="slider" min="0" max="5" step="1" value="0" />
  </div>
  <span id="sliderLabel">00:00</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script>
  const map = L.map('map').setView([44.214, 0.606], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const getColor = i => ["#FADADD", "#F5B7B1", "#EC7063", "#E74C3C", "#CB4335", "#943126", "#78281F"][Math.min(6, Math.max(0, i - 1))];
  const generatePoints = n => Array.from({ length: n }, (_, i) => [{ lat: 44.21 + i * 0.001, lon: 0.606 + i * 0.001, intensite: 1 + (i % 7) }]);
  const dataset = {
    today: generatePoints(6),
    yesterday: generatePoints(6),
    last7: generatePoints(7),
    last30: generatePoints(10),
    custom: generatePoints(4),
    single: generatePoints(6)
  };

  const slider = document.getElementById("slider");
  const label = document.getElementById("sliderLabel");
  const preset = document.getElementById("preset");
  const modeDynamic = document.getElementById("modeDynamic");
  const customInput = document.getElementById("customRange");
  const singleInput = document.getElementById("singleDate");

  flatpickr.setDefaults({ locale: "fr" });
  flatpickr("#customRange", { mode: "range", dateFormat: "d/m/Y" });
  flatpickr("#singleDate", { dateFormat: "d/m/Y" });

  let currentLayer = null;
  let activeData = dataset["today"];
  let activeLabels = [];

  const updateMap = (points) => {
    if (currentLayer) map.removeLayer(currentLayer);
    currentLayer = L.layerGroup();
    points.forEach(pt => {
      L.circle([pt.lat, pt.lon], {
        color: getColor(pt.intensite),
        fillColor: getColor(pt.intensite),
        fillOpacity: 0.6,
        radius: 60
      }).addTo(currentLayer);
    });
    currentLayer.addTo(map);
  };

  const getLabels = (key, len) => {
    if (["today", "yesterday", "single"].includes(key))
      return Array.from({ length: len }, (_, i) => `00:${(i * 10).toString().padStart(2, '0')}`);
    if (key === "last7")
      return Array.from({ length: len }, (_, i) => `${i}h`);
    return Array.from({ length: len }, (_, i) => `Jour ${i + 1}`);
  };

  const refreshMode = () => {
    const isActive = modeDynamic.checked;
    slider.disabled = !isActive;
    slider.classList.toggle("disabled", !isActive);
    if (isActive) {
      updateMap(activeData[slider.value]);
      label.innerText = activeLabels[slider.value];
    } else {
      updateMap(activeData.flat());
      label.innerText = " ";
    }
  };

  preset.onchange = () => {
    const key = preset.value;
    customInput.style.display = key === "custom" ? "inline-block" : "none";
    singleInput.style.display = key === "single" ? "inline-block" : "none";
    activeData = dataset[key];
    activeLabels = getLabels(key, activeData.length);
    slider.max = activeData.length - 1;
    slider.value = 0;
    refreshMode();
  };

  modeDynamic.onchange = refreshMode;

  slider.oninput = () => {
    if (!modeDynamic.checked) return;
    label.innerText = activeLabels[slider.value];
    updateMap(activeData[slider.value]);
  };

  // Init
  activeLabels = getLabels("today", dataset.today.length);
  refreshMode();
</script>
</body>
</html>
