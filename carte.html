<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte - Usine ATEMAX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #new-signal {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 12px; border-radius: 8px;
      font-weight: bold; font-size: 14px; z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-decoration: none; color: black;
    }
    #controls {
      max-width: 92vw;
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 10px; border-radius: 10px;
      font-size: 13px; z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px;
    }
    label, select, input[type="checkbox"], input[type="range"], span { font-size: 13px; }
    input[type="range"] { width: 140px; transition: opacity 0.3s ease; }
    input[type="range"].disabled { opacity: 0.3; pointer-events: none; }
    .hidden { display: none !important; }
    .flatpickr-calendar { z-index: 3000 !important; }
    @media (max-width: 600px) {
      #controls { flex-wrap: wrap; overflow-x: auto; justify-content: flex-start; }
      input[type="range"] { width: 100px; }
    }
    .wind-icon svg {
      width: 120px;
      height: 120px;
      opacity: 0.6;
    }
    .wind-speed {
      background: rgba(255,255,255,.85);
      padding: 3px 8px;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,.25);
      font-weight: bold;
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">‚ûï Faire un nouveau signalement</a>
<div id="map"></div>

<div id="controls">
  <div style="display:flex; align-items:center;">
    <span style="margin-right:4px;">üìÖ</span>
    <select id="preset">
      <option value="today">Aujourd‚Äôhui</option>
      <option value="yesterday">Hier</option>
      <option value="last7">7 derniers jours</option>
      <option value="last30">30 derniers jours</option>
      <option value="custom">P√©riode personnalis√©e</option>
      <option value="single">Choisir une date</option>
    </select>
  </div>
  <input id="customRange" type="text" class="hidden" placeholder="Date d√©but - fin" readonly />
  <input id="singleDate" type="text" class="hidden" placeholder="Choisir une date" readonly />

  <label><input type="checkbox" id="modeDynamic" checked /> √âvolution dynamique</label>

  <div style="display:flex; align-items:center; gap:6px;">
    <span style="margin-right:4px;">‚è±Ô∏è</span>
    <input type="range" id="slider" min="0" max="0" value="0" />
  </div>
  <span id="sliderLabel">00:00</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script>
  const map = L.map('map').setView([44.214, 0.606], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const USINE = [44.212805, 0.597916];
  const usineIcon = L.divIcon({ html: '<div style="font-size:48px;">üè≠</div>', iconSize: [48,48], className: 'usine-marker' });
  L.marker(USINE, { icon: usineIcon }).addTo(map).bindPopup("Usine d'incin√©ration ATEMAX");

  function offsetLatLng(lat, lon, dxMeters, dyMeters) {
    const dLat = dyMeters / 111320;
    const dLon = dxMeters / (111320 * Math.cos(lat * Math.PI / 180));
    return [lat + dLat, lon + dLon];
  }

  const WIND_POS = offsetLatLng(USINE[0], USINE[1], 200, 0);
  let windMarker = null;
  function makeWindIcon(dirDeg, speedKmh) {
    const svg = `<svg viewBox='0 0 100 100' style='transform: rotate(${dirDeg}deg);'>
      <path d='M50 4 L72 58 L56 52 L56 96 L44 96 L44 52 L28 58 Z' fill='black' fill-opacity='0.6' stroke='white' stroke-width='4' stroke-linejoin='round'/>
    </svg>`;
    const html = `<div class='wind-icon'>${svg}<div class='wind-speed'>${speedKmh} km/h</div></div>`;
    return L.divIcon({ html, className: '', iconSize: [120, 120], iconAnchor: [60, 60] });
  }

  function updateWindMarker(dir, speed) {
    if (!windMarker) {
      windMarker = L.marker(WIND_POS, { icon: makeWindIcon(dir, speed), interactive: false }).addTo(map);
    } else {
      windMarker.setIcon(makeWindIcon(dir, speed));
    }
  }

  async function fetchWindAndUpdate() {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${USINE[0]}&longitude=${USINE[1]}&current=wind_speed_10m,wind_direction_10m&timezone=auto`;
      const res = await fetch(url);
      const json = await res.json();
      const cur = json.current || json.current_weather || {};
      const dir = cur.wind_direction_10m ?? cur.winddirection ?? 0;
      const speed = cur.wind_speed_10m ?? cur.windspeed ?? 0;
      updateWindMarker(dir, Math.round(speed));
    } catch(e) {
      console.error('Erreur m√©t√©o', e);
    }
  }

  updateWindMarker(0, '?');
  fetchWindAndUpdate();
  setInterval(fetchWindAndUpdate, 300000);
</script>
</body>
</html>
