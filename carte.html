<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte des odeurs - Donn√©es r√©elles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 8px;
      max-width: 92vw;
    }
    #new-signal {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-decoration: none;
      color: black;
    }
    input[type="range"] {
      width: 120px;
      transition: opacity 0.3s ease;
    }
    input[type="range"].disabled {
      opacity: 0.3;
      pointer-events: none;
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">‚ûï Faire un nouveau signalement</a>
<div id="map"></div>
<div id="controls">
  <label>üìÖ <select id="preset">
    <option value="today">Aujourd'hui</option>
    <option value="yesterday">Hier</option>
    <option value="last7">7 derniers jours</option>
    <option value="last30">30 derniers jours</option>
    <option value="custom">P√©riode personnalis√©e</option>
    <option value="single">Choisir une date</option>
  </select></label>
  <input id="customRange" class="datepicker" placeholder="Date d√©but - fin" />
  <input id="singleDate" class="datepicker" placeholder="Date" />
  <label><input type="checkbox" id="modeDynamic" checked /> √âvolution dynamique</label>
  <label>‚è±Ô∏è <input type="range" id="slider" min="0" max="0" value="0" /></label>
  <span id="sliderLabel">00:00</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script>
  const sheetUrl = "https://opensheet.elk.sh/1z6YXiX0MKEwrZ0rnjgj4mfFSUSk6wRh6-kRK9JCSIzc/Feuille%201";
  const map = L.map('map').setView([44.2128, 0.5979], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

  const getColor = i => ["#FADADD", "#F5B7B1", "#EC7063", "#E74C3C", "#CB4335", "#943126", "#78281F", "#641E16", "#512E2E", "#2E0E0E"][Math.min(9, Math.max(0, i-1))];

  let allData = [], grouped = [], labels = [];
  const slider = document.getElementById("slider"), label = document.getElementById("sliderLabel"), modeDynamic = document.getElementById("modeDynamic");

  const updateMap = (points) => {
    if (window.layer) map.removeLayer(window.layer);
    window.layer = L.layerGroup(points.map(p =>
      L.circle([p.lat, p.lon], {
        color: getColor(p.intensite),
        fillColor: getColor(p.intensite),
        fillOpacity: 0.6,
        radius: 60
      }).bindPopup(`<strong>${p.type}</strong><br>Intensit√© : ${p.intensite}/10<br>${p.commentaire}<br>${p.date}`)
    )).addTo(map);
  };

  const groupBy = (data, interval) => {
    const grouped = {};
    data.forEach(row => {
      const date = new Date(row.date);
      let key = "";
      if (interval === '10min') {
        date.setSeconds(0,0);
        date.setMinutes(Math.floor(date.getMinutes()/10)*10);
        key = date.toISOString();
      } else if (interval === 'hour') {
        date.setMinutes(0,0,0);
        key = date.toISOString();
      } else if (interval === 'day') {
        date.setHours(0,0,0,0);
        key = date.toISOString();
      }
      grouped[key] = grouped[key] || [];
      grouped[key].push(row);
    });
    const keys = Object.keys(grouped).sort();
    labels = keys.map(k => new Date(k).toLocaleString("fr-FR"));
    return keys.map(k => grouped[k]);
  };

  const refresh = (mode) => {
    let gtype = 'day';
    const today = new Date();
    if (mode === 'today' || mode === 'yesterday' || mode === 'single') gtype = '10min';
    else if (mode === 'last7') gtype = 'hour';
    else if (mode === 'last30') gtype = 'day';
    else if (mode === 'custom') {
      const input = document.getElementById("customRange")._flatpickr.selectedDates;
      const diff = (input[1]-input[0])/86400000;
      gtype = diff <= 1 ? '10min' : diff <= 7 ? 'hour' : 'day';
    }
    grouped = groupBy(allData.filter(d => {
      const date = new Date(d.date);
      if (mode === 'today') return date.toDateString() === today.toDateString();
      if (mode === 'yesterday') {
        const y = new Date(today); y.setDate(y.getDate()-1);
        return date.toDateString() === y.toDateString();
      }
      if (mode === 'last7') { const d = new Date(today); d.setDate(d.getDate()-7); return date >= d; }
      if (mode === 'last30') { const d = new Date(today); d.setDate(d.getDate()-30); return date >= d; }
      if (mode === 'single') {
        const sel = document.getElementById("singleDate")._flatpickr.selectedDates[0];
        return date.toDateString() === sel?.toDateString();
      }
      if (mode === 'custom') {
        const [d1,d2] = document.getElementById("customRange")._flatpickr.selectedDates;
        return d1 && d2 && date >= d1 && date <= d2;
      }
      return true;
    }), gtype);

    slider.max = grouped.length-1;
    slider.value = 0;
    updateMap(grouped[0]);
    label.innerText = labels[0];
  };

  modeDynamic.onchange = () => {
    const enabled = modeDynamic.checked;
    slider.disabled = !enabled;
    slider.classList.toggle("disabled", !enabled);
    updateMap(enabled ? grouped[slider.value] : grouped.flat());
    label.innerText = enabled ? labels[slider.value] : "";
  };
  slider.oninput = () => {
    updateMap(grouped[slider.value]);
    label.innerText = labels[slider.value];
  };

  document.getElementById("preset").onchange = e => refresh(e.target.value);
  flatpickr.setDefaults({ locale: "fr" });
  flatpickr("#customRange", { mode: "range", dateFormat: "d/m/Y", onClose: () => refresh("custom") });
  flatpickr("#singleDate", { dateFormat: "d/m/Y", onClose: () => refresh("single") });

  fetch(sheetUrl)
    .then(res => res.json())
    .then(rows => {
      allData = rows.map(r => ({
        lat: parseFloat(r["Latitude"]),
        lon: parseFloat(r["Longitude"]),
        intensite: parseInt(r["Intensit√©"]),
        type: r["Type d‚Äôodeur"],
        commentaire: r["Commentaire"],
        date: r["Date/heure"]
      })).filter(d => !isNaN(d.lat) && !isNaN(d.lon) && d.date);
      refresh("today");
    });
</script>
</body>
</html>
