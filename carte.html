<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte ATEMAX ‚Äì AutoPlay + Synth√®se OK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #new-signal {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 12px; border-radius: 8px;
      font-weight: bold; font-size: 14px; z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-decoration: none; color: black;
    }
    #controls {
      max-width: 92vw;
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 10px; border-radius: 10px;
      font-size: 13px; z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px;
    }
    label, select, input[type="checkbox"], input[type="range"], span { font-size: 13px; }
    input[type="range"] { width: 140px; transition: opacity 0.3s ease; }
    input[type="range"].disabled { opacity: 0.3; pointer-events: none; }
    .hidden { display: none !important; }
    .flatpickr-calendar { z-index: 3000 !important; }

    /* Player */
    #playerControls { display:flex; align-items:center; gap:6px; }
    #btnPlayPause{
      width:32px;height:32px;border:none;border-radius:50%;cursor:pointer;
      box-shadow:0 1px 3px rgba(0,0,0,.3);background:#E74C3C;color:#fff;font-size:16px;line-height:32px;padding:0;
      display:flex;align-items:center;justify-content:center;font-weight:bold;
    }
    #speedSelect{ border:1px solid #ccc; border-radius:6px; padding:2px 4px; }

    /* Ic√¥ne vent */
    .wind-icon svg { width:120px; height:120px; opacity:0.6; }
    .wind-speed{
      background:rgba(255,255,255,.85);
      padding:3px 8px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.25);
      font-weight:bold;text-align:center;margin-top:4px;
    }

    @media (max-width: 600px) {
      #controls { flex-wrap: wrap; overflow-x: auto; justify-content: flex-start; }
      input[type="range"] { width: 100px; }
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">‚ûï Faire un nouveau signalement</a>
<div id="map"></div>

<div id="controls">
  <div style="display:flex; align-items:center;">
    <span style="margin-right:4px;">üìÖ</span>
    <select id="preset">
      <option value="today">Aujourd‚Äôhui</option>
      <option value="yesterday">Hier</option>
      <option value="last7">7 derniers jours</option>
      <option value="last30">30 derniers jours</option>
      <option value="custom">P√©riode personnalis√©e</option>
      <option value="single">Choisir une date</option>
    </select>
  </div>
  <input id="customRange" type="text" class="hidden" placeholder="Date d√©but - fin" readonly />
  <input id="singleDate" type="text" class="hidden" placeholder="Choisir une date" readonly />

  <!-- Par d√©faut d√©coch√© pour afficher la synth√®se -->
  <label><input type="checkbox" id="modeDynamic" /> √âvolution dynamique</label>

  <div style="display:flex; align-items:center; gap:6px;">
    <span style="margin-right:4px;">‚è±Ô∏è</span>
    <input type="range" id="slider" min="0" max="0" value="0" class="disabled" disabled />
  </div>
  <span id="sliderLabel"></span>

  <!-- Player auto play/pause -->
  <div id="playerControls" class="hidden">
    <button id="btnPlayPause" title="Lecture/Pause">‚ñ∂</button>
    <select id="speedSelect" title="Vitesse">
      <option value="1000">x1</option>
      <option value="500">x2</option>
      <option value="250">x4</option>
    </select>
    <label style="display:flex; align-items:center; gap:3px;">
      <input type="checkbox" id="loop" checked /> R√©p√©ter
    </label>
  </div>
</div>

<!-- Libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>

<script>
// (le reste du script reste inchang√©, seule la fonction `modeDynamic.onchange` est modifi√©e ci-dessous)

modeDynamic.onchange = () => {
  const canSlide = modeDynamic.checked && grouped.length > 1;
  slider.disabled = !canSlide;
  slider.classList.toggle('disabled', !canSlide);
  playerControls.classList.toggle('hidden', !canSlide);

  if (!modeDynamic.checked) {
    pause();
    showSynthesis();
  } else {
    slider.max = Math.max(0, grouped.length - 1);
    if (+slider.value > +slider.max) slider.value = slider.max;
    setFrame(+slider.value || 0);
    play(); // <-- Lecture automatique √† l‚Äôactivation
  }
};
</script>
</body>
</html>
