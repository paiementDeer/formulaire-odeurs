<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte ATEMAX ‚Äì AutoPlay + Synth√®se OK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    html, body, #map { height: 100%; margin: 0; font-family: sans-serif; }
    #new-signal {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 12px; border-radius: 8px;
      font-weight: bold; font-size: 14px; z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); text-decoration: none; color: black;
    }

    /* HUD vent (fl√®che + vitesse) */
    #windHud {
      position: absolute; top: 10px; right: 10px; z-index: 1002; /* au-dessus du bouton */
      display: flex; flex-direction: column; align-items: center; pointer-events: none;
    }
    .wind-icon svg { width:60px; height:60px; opacity:0.6; }
    .wind-speed{
      background:rgba(255,255,255,.85);
      padding:3px 8px;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.25);
      font-weight:bold;text-align:center;margin-top:4px; font-size:11px;
    }

    #controls {
      max-width: 92vw;
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 6px 10px; border-radius: 10px;
      font-size: 13px; z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px;
    }
    label, select, input[type="checkbox"], input[type="range"], span { font-size: 13px; }
    input[type="range"] { width: 140px; transition: opacity 0.3s ease; }
    input[type="range"].disabled { opacity: 0.3; pointer-events: none; }
    .hidden { display: none !important; }
    .flatpickr-calendar { z-index: 3000 !important; }

    /* Player */
    #playerControls { display:flex; align-items:center; gap:6px; }
    #btnPlayPause{
      width:32px;height:32px;border:none;border-radius:50%;cursor:pointer;
      box-shadow:0 1px 3px rgba(0,0,0,.3);background:#E74C3C;color:#fff;font-size:16px;line-height:32px;padding:0;
      display:flex;align-items:center;justify-content:center;font-weight:bold;
    }
    #speedSelect{ border:1px solid #ccc; border-radius:6px; padding:2px 4px; }

    @media (max-width: 600px) {
      #controls { flex-wrap: wrap; overflow-x: auto; justify-content: flex-start; }
      input[type="range"] { width: 100px; }
    }

    /* Canvas particules */
    canvas.particle-canvas {
      position:absolute; top:0; left:0; pointer-events:none; z-index: 500; /* sous les contr√¥les */
    }
  </style>
</head>
<body>
<a href="index.html" id="new-signal">‚ûï Faire un nouveau signalement</a>
<div id="windHud"></div>
<div id="map"></div>

<!-- CONTROLS + SCRIPTS INCHANG√âS... -->

<script>
function parseFrDate(str){
  const [d,m,rest]=str.split('/');
  if(!rest) return new Date(str);
  const [y,time='00:00:00']=rest.split(' ');
  const [hh,mm,ss]=time.split(':');
  return new Date(+y,+m-1,+d,+(hh||0),+(mm||0),+(ss||0));
}
function avg(arr){return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:NaN;}
function avgDir(degArr){
  if(!degArr.length) return NaN;
  let x=0,y=0;degArr.forEach(d=>{const r=d*Math.PI/180;x+=Math.cos(r);y+=Math.sin(r);});
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function numVal(v){const n=parseFloat(String(v).replace(',','.'));return isNaN(n)?NaN:n;}
function windDirectionLabel(deg){
  if (isNaN(deg)) return '‚Äî';

  const dirs = [
    { a:   0, t: 'du nord' },
    { a:  45, t: 'du nord-est' },
    { a:  90, t: 'de l‚Äôest' },
    { a: 135, t: 'du sud-est' },
    { a: 180, t: 'du sud' },
    { a: 225, t: 'du sud-ouest' },
    { a: 270, t: 'de l‚Äôouest' },
    { a: 315, t: 'du nord-ouest' }
  ];

  const closest = dirs.reduce((p, c) =>
    Math.abs(c.a - deg) < Math.abs(p.a - deg) ? c : p
  );

  return closest.t;
}

// üü¢ AJOUT ICI ‚Äî fonction utilitaire demand√©e
function hasAnySignalement(pointsArray) {
  return Array.isArray(pointsArray) && pointsArray.length > 0 && pointsArray.some(arr => arr.length > 0);
}

// ...le reste du script inchang√©...
</script>

</body>
</html>
